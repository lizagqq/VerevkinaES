#!/bin/bash

echo "========================================================================"
echo "ЛАБОРАТОРНАЯ РАБОТА №13: ОПТИМИЗАЦИЯ И ПРОФИЛИРОВАНИЕ"
echo "Метод сопряжённых градиентов"
echo "========================================================================"

# Переход в директорию src
cd src

# Этап 1: Генерация тестовых данных
echo ""
echo "========================================================================"
echo "ЭТАП 1: Генерация тестовых данных"
echo "========================================================================"

python3 generate_data.py --size 500 250 --condition 10 --prefix ""
python3 generate_data.py --size 1000 500 --condition 10 --prefix "med_"
python3 generate_data.py --size 2000 1000 --condition 10 --prefix "large_"

# Этап 2: Профилирование базовой версии
echo ""
echo "========================================================================"
echo "ЭТАП 2: Профилирование базовой версии"
echo "========================================================================"

echo "Профилирование на 1 процессе..."
mpiexec -n 1 python3 profile_cg.py

echo ""
echo "Профилирование на 2 процессах..."
mpiexec -n 2 python3 profile_cg.py

echo ""
echo "Профилирование на 4 процессах..."
mpiexec -n 4 python3 profile_cg.py

# Этап 3: Бенчмарки для разного количества процессов
echo ""
echo "========================================================================"
echo "ЭТАП 3: Комплексное тестирование производительности"
echo "========================================================================"

for np in 1 2 4 8; do
    echo ""
    echo "Тестирование на $np процессах..."
    mpiexec -n $np python3 benchmark_cg.py
done

# Этап 4: Визуализация результатов
echo ""
echo "========================================================================"
echo "ЭТАП 4: Визуализация результатов"
echo "========================================================================"

python3 visualize_results.py

# Этап 5: Тестирование оптимизированной версии
echo ""
echo "========================================================================"
echo "ЭТАП 5: Демонстрация оптимизированной версии"
echo "========================================================================"

echo "Запуск на 4 процессах..."
mpiexec -n 4 python3 cg_optimized.py

echo ""
echo "========================================================================"
echo "ВСЕ ТЕСТЫ ЗАВЕРШЕНЫ"
echo "========================================================================"
echo ""
echo "Результаты:"
echo "  - Графики: images/"
echo "  - Сводная таблица: results_summary.txt"
echo "  - Профили: profile_rank_*.txt"
echo "  - Бенчмарки: benchmark_results_p*.json"
